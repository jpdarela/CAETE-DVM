# CAETE-DVM Build and use Overview

[⇦ Back](./README.md)

---

## Introduction to CAETE-DVM

### CAETE Dynamic Vegetation Model
- Code is divided in two main parts:
  - Python interface for data handling and configuration
  - Fortran backend for numerical computations
- Requires compilation of Python extension modules
- Cross-platform support (Windows, Linux, macOS)

---

## Python source code

### Sources
- **region.py**: handles the execution over gridcells
- **caete.py**: Definition of the gridcell (grd_mt class)
- **metacommunity.py**: metacommunity class,  contains multiple communities
- **community.py**: community class, plant biomass is handled here
- **other scripts**: utility functions, input handling, preprocessing, jit compiled routines ...

---

## Fortran source code

### Core Library Files (src_lib)
- **types.f90**: numerical type definitions
- **global.f90**: Global parameters and constants
- **photo_par.f90**: Photosynthesis parameters
- **funcs.f90**: GPP related functions and utilities
- **evap.f90**: Evapotranspiration calculations
- **soil_dec.f90**: Soil decomposition processes
- **cc.f90**: Carbon costs calculations
- **allocation.f90**: Resource allocation algorithms
- **productivity.f90**: Primary Productivity calculations

---


### Budget Module Options

#### Daily Time Step Budget Calculation for all PLSs
- **budget_fixed.F90**: Stack allocation (faster, default)
- **budget.F90**: Heap allocation (slower, larger PLS support)

---

## Makefiles
- **Makefile**: For Linux and macOS builds
- **Makefile_win**: For Windows builds (MSVC + OneAPI)

---

## Software Requirements

### Compiler Requirements
| Platform | C Compiler | Fortran Compiler |
|----------|------------|------------------|
| Windows | MSVC (mandatory) | Intel OneAPI |
| Linux/macOS | gcc | gfortran |

---

### Python Requirements
- **Windows**: Python == 3.11
- **Linux/macOS**: Python >= 3.11 <= 3.13
- Required: `pip` and `numpy.f2py`

---

## Windows-Specific Setup

### Installation Order
1. **First**: Install MSVC
2. **Second**: Install Intel OneAPI

### Python Management
- Use official Python 3.11 installer
- Consider Python Install Manager (PIM) for multiple versions

---

## Linux/macOS Setup

### Recommended Tools
- **Python Version Management**: `pyenv`
- **Package Management**: Standard `pip`
- **Compilers**: Usually pre-installed or easily available

### Avoid System Python
- Use isolated Python environments
- Prevents system conflicts
- Ensures reproducibility

---

## Compilation Process

### Quick Test Method
1. Follow [NumPy f2py "quick way"](https://numpy.org/doc/stable/f2py/f2py.getting-started.html#)
2. If successful → CAETE compilation likely to work
3. Use provided Makefiles for actual build

### Build Tools
- **Linux/macOS**: Standard `Makefile`
- **Windows**: Adapted `Makefile_win` (MSVC + OneAPI)

---

## Critical Security Warnings

### System Python Risks (Linux)
- **System Conflicts**: Can break core utilities
- **Security Issues**: Global installs require sudo
- **Version Lock-in**: Stuck with distribution version

### Best Practices
- Use `pyenv`, `conda`, or `uv` for Python management
- Never modify system Python installation

---


## Input Data Overview

### Data Sources
- **Source**: ISIMIP repository (ISIMIP3a and ISIMIP3b protocols)
- **Format**: NetCDF files and legacy `.pbz2` files
- **Processing**: Custom preprocessing scripts included

### Key Components
- Bias-corrected data from ISIMIP repo in `_raw` folders
- Gridlist tables for execution control
- Input folders: `spinclim`, `obsclim`, `historical`, scenarios

---

## Available Data (link in the repo's readme)

### Climate Data
- **20CRv3-ERA5**: Historical observational (`spinclim` & `obsclim`)
- **MPI-ESM1-2-HR**: Model scenarios (`piControl`, `historical`, `ssp370`, `ssp585`)

---


## Data Processing Pipeline

### Preprocessing Scripts
- `preprocess_caete.py`: ISIMIP → NetCDF for CAETE
- `preprocess_caete_pbz2.py`: ISIMIP → Legacy `.pbz2`
- Configurable via `input/pre_processing.toml`

### Gridlist Generation
- Generated by `input_handler` class
- Required for gridcell execution
- Saved alongside input files
- grd folder has some examples

---


## Quick Start Summary

### Pre-flight Check
1. ✅ Verify Python version compatibility
2. ✅ Install compilers in correct order (Windows)
3. ✅ Test f2py "quick way"
4. ✅ Download required input data

### Build & Run
1. Compile extension modules using Makefile
2. Configure `caete.toml` for your setup
3. Run model with prepared input files and gridlists

---

*For detailed instructions, see the complete build_instructions.md file*
