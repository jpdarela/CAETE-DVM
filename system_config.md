# System Configuration

[⇦ Back](./README.md)

Before building the CAETÊ source code, ensure that your system is properly configured. Read the [build_instructions](./build_instructions.md) file for more information about setting up the development environment on different operating systems. This document provides an overview of the system requirements and configuration steps.

## Table of Contents

- [Windows Setup](#windows-setup)
- [Linux/macOS Setup](#linuxmacos-setup)

---

## Windows Setup

PowerShell 7 must be installed to run script utilities on Windows, including Makefiles. You can install it with winget:

```powershell
winget install --id=Microsoft.PowerShell
```

### System Encoding

On Windows, you will likely need to change the system encoding to UTF-8. This can be done in:
**Control Panel > Region > Administrative > Change system locale**. Check the box for **"Beta: Use Unicode UTF-8 for worldwide language support"** and then restart your computer. This step is required to run the model on Windows.

**Why is this necessary?** Default Windows terminals use legacy code pages (e.g., cp1252) that cannot handle Unicode characters in Fortran files. However, f2py expects UTF-8 by default.

Check the current system encoding in PowerShell ("PS>" is the PowerShell prompt):

```powershell
PS> [System.Text.Encoding]::Default
```

This will return something like:

```powershell
Preamble          :
BodyName          : utf-8
EncodingName      : Unicode (UTF-8)
HeaderName        : utf-8
WebName           : utf-8
WindowsCodePage   : 1200
IsBrowserDisplay  : True
IsBrowserSave     : True
IsMailNewsDisplay : True
IsMailNewsSave    : True
IsSingleByte      : False
EncoderFallback   : System.Text.EncoderReplacementFallback
DecoderFallback   : System.Text.DecoderReplacementFallback
IsReadOnly        : True
CodePage          : 65001
```

If the `EncodingName` is not `Unicode (UTF-8)`, you must change it as described above.


### C Compiler and Build Tools

`cl.exe`, `link.exe`, and `nmake.exe` are required to build the model on Windows. These tools are included with the C/C++ workload in the Microsoft Build Tools. Optionally, you can install the full Visual Studio IDE, but it is not necessary to run the model. The C/C++ workload is required to compile the C code generated by the NumPy `f2py` module.
You can [download the Visual Studio Build Tools installer here](https://visualstudio.microsoft.com/downloads/#build-tools-for-visual-studio-2022).

### Fortran Compiler

There are two options for a Fortran compiler on Windows:
- `ifx.exe` - Intel Fortran Compiler
- `gfortran.exe` - GNU Fortran Compiler (part of mingw-w64)

[Download the oneAPI HPC Toolkit Essentials](https://www.intel.com/content/www/us/en/developer/tools/oneapi/hpc-toolkit-download.html?packages=fortran-essentials&fortran-essentials-os=windows&fortran-essentials-win=offline).

If you want to use gfortran, [download mingw-w64 from WinLibs](https://winlibs.com/#download-release). Download GCC 14.2.0 (with MCF threads) + MinGW-w64 12.0.0 (UCRT) - release 1 and add the `bin` folder to your PATH environment variable.

### Python and Dependencies

- [Python 3.11](https://www.python.org/ftp/python/3.11.9/python-3.11.9-amd64.exe)
- [Python requirements](./src/requirements_3xx_last.txt) for Windows.

See the [Windows Makefile](./src/Makefile_win) for instructions on how to build the Python extension module.

The Windows Makefile calls the `ifx.exe` compiler. The Makefile must be executed in a [shell with the proper environment
In the windows Makefile the ifx.exe compiler is called. The Makefile must be executed in a [shell with the proper environment](https://www.intel.com/content/www/us/en/docs/oneapi/programming-guide/2023-0/use-the-setvars-script-with-windows.html#GUID-D22D6A5C-25BC-46EE-B8D9-3530184ADCD6)


To build in windows:

Assuming that the Intel OneAPI setvars.bat script is in C:\Program Files (x86)\Intel\oneAPI\setvars.bat.

```powershell
cmd.exe "/K" '"C:\Program Files (x86)\Intel\oneAPI\setvars.bat" && pwsh.exe'

```

You can easily create a shortcut or a script to open a powershell terminal with the proper environment.

After that, navigate to the src folder and run the following to install python deps and build the extension module with python 3.11 in windows:

```Powershell
nmake -f Makefile_win setup
nmake -f Makefile_win
```

---

## Alternative: Using gfortran in windows

- The recommended option is the Intel fortran compiler (ifx.exe) included in the Intel OneAPI fortran essentials toolkit

- If you want to use gfortran, you can download a standalone version from [WinLibs](https://winlibs.com/#download-release).

- Tested with: GCC 14.2.0 (with MCF threads) + MinGW-w64 12.0.0 (UCRT) - release 1

- Make sure that gfortran.exe and the other build tools are in your PATH environment variable.

- Use the script build_caete.bat to build the model with gfortran in windows. This script just applies the numpy.f2py script to build the fortran/python extension module searching for the gfortran and c compilers in the PATH. This combination is pretty raw. I recommend using the Intel fortran compiler if possible. Be aware that using gfortran in windows may lead to unexpected issues, specially issues related to linking the fortran runtime libraries. I tested this in one machine only, with windows 11 pro and mingw64 from winlibs. I used a python 3.11.13 installation built localy from source with the MS Visual compiler.

## Linux/MacOS setup

- gnu-make

- gcc

- gfortran

- python >= 3.11 + pip

In linux it is possible to run the model in python 3.11, 3.12 and 3.13. However, the building system used to compile the fortran/python extension module differs between python versions. In python 3.12 the numpy distutils was removed from numpy. See: [Numpy distutils status](https://numpy.org/doc/stable/reference/distutils_status_migration.html#distutils-status-migration). The new (candidate) build method is based on meson. So, if you are using python >=3.12 you will need also:

- meson
- ninja

Note: At the current time, the new building (meson) system was only working on linux. If you are using windows, you will need to use python 3.11.

Python Dependencies: see the [requirements](./src/requirements_3xx_last.txt).

Edit the PYEXEC variable in the [linux Makefile](./src/Makefile) to match the python that you will use to run the model.

Use the make target setup to install python libraries.

To build the extension module in linux, navigate to the src folder and run:

```bash
make setup
make
```

## Running the model

### Generating the PLS table

The PLS (Plant Life Strategy) table is required for running the CAETÊ model. You can generate the PLS table using the `plsgen.py` script located in the `src` folder. This script creates a PLS table based on the specified parameters and saves it as a CSV file.

Navigate to the `src` folder and run the following command to see the available options for the `plsgen.py` script:

```bash
python plsgen.py -h
```

This will display the help message with the available options. To generate a PLS table with 10,000 entries and save it to a file named  pls_attrs-10000.csv inside the `PLS_MAIN` folder in the src directory, run the following command:

```bash
python plsgen.py -n 10000 -f PLS_MAIN

```

After generating the PLS table, you can use it to run the CAETÊ model by specifying the path to the generated CSV file in the model driver script.

### Model configuration

Model configuration parameters are set in the ```caete.toml``` file located in the src folder. You can edit this file to change model parameters before running the model. The config.py script has a class that reads the ```caete.toml``` file and makes the parameters available to the model after a validation step. To include new parameters in the ```caete.toml``` file, you will need to edit the config.py script to include the new parameters in the validation step.

After building the extension module, you can run the model from the src folder using the same python executable that is used in your Makefile.

```bash
$ python caete_driver.py

# or

$ python caete_driver_CMIP6.py

```

The idea is that when you want to do a experiment with the model, you create a script that mimics the caete_driver.py script but with your own configuration (e.g., different input files, different output files, different spinup configurations).

```caete_driver.py``` runs the model with a subset (n=16) of the gridcells in the input files.

```caete_driver_CMIP6.py``` runs the model with CMIP6 forcing data for 4 gridcells . You need to edit the paths to the input data files in the ```caete_driver_CMIP6.py``` and ```caete_driver.py``` scripts before running them.

[⇦ Back](./README.md)