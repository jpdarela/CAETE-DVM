# System Configuration

[⇦ Back](./README.md)

Before building the CAETE source code, ensure that your system is properly configured. read the [build_instructions](./build_instructions.md) file for more information about setting up the development environment in different operating systems. Here we present an overview of the system requirements and configuration steps.

## Table of Contents
  - [Windows setup](#windows-setup)
  - [Linux/MacOS setup](#linuxmacos-setup)


---

## Windows setup

PowerShell 7 must be installed to run script utilities in windows, including Makefiles. You can install it with winget:

```powershell
winget install --id=Microsoft.PowerShell
```
### System Encoding

In windows you will probably need to modify the System encoding to UTF-8. This can be done in the

Control Panel -> Region -> Administrative -> Change system locale -> check the box "Beta: Use Unicode UTF-8 for worldwide language support". After that, restart the computer. This is needed to run the model in windows.

Why? Default windows terminals use legacy code pages (e.g., cp1252) that can't handle Unicode characters in Fortran files. However f2py expects UTF-8 by default

Check the current system encoding in powershell ("PS>" is the powershell prompt):

```powershell
PS> [System.Text.Encoding]::Default
```

It will return something like:

```powershell
Preamble          :
BodyName          : utf-8
EncodingName      : Unicode (UTF-8)
HeaderName        : utf-8
WebName           : utf-8
WindowsCodePage   : 1200
IsBrowserDisplay  : True
IsBrowserSave     : True
IsMailNewsDisplay : True
IsMailNewsSave    : True
IsSingleByte      : False
EncoderFallback   : System.Text.EncoderReplacementFallback
DecoderFallback   : System.Text.DecoderReplacementFallback
IsReadOnly        : True
CodePage          : 65001
```

If the encoding name is not Unicode (UTF-8), you will need to change it as described above.


### C compiler and build tools

cl.exe, link.exe, nmake.exe are required to build the model in windows - these tools are included in the
Microsoft build with C/C++ workload. Optionally, you can install the full visual studio IDE, but it is not necessary to run the model. The C/C++ workload is required to compile the C code generated by the numpy f2py module.
You can download the Visual Studio/build [tools Installer from here](https://visualstudio.microsoft.com/downloads/#build-tools-for-visual-studio-2022).

### Fortran compiler

There are two options for a Fortran compilers in windows:
- ifx.exe - Intel fortran compiler
- gfortran.exe - GNU fortran compiler (part of mingw-w64)

[Download the OneAPI fortran essentials](https://www.intel.com/content/www/us/en/developer/tools/oneapi/hpc-toolkit-download.html?packages=fortran-essentials&fortran-essentials-os=windows&fortran-essentials-win=offline).

[Download mingw64 from WinLibs](https://winlibs.com/#download-release) if you want to use gfortran, Download GCC 14.2.0 (with MCF threads) + MinGW-w64 12.0.0 (UCRT) - release 1 and append the bin folder to your PATH environment variable.

### Python and Python dependencies

[Python 3.11](https://www.python.org/ftp/python/3.11.9/python-3.11.9-amd64.exe) and [python requirements](./src/requirements_3xx_last.txt) for windows.

See the [windows Makefile](./src/Makefile_win) for instructions on how to build the python extension module.

In the windows Makefile the ifx.exe compiler is called. The Makefile must be executed in a [shell with the proper environment](https://www.intel.com/content/www/us/en/docs/oneapi/programming-guide/2023-0/use-the-setvars-script-with-windows.html#GUID-D22D6A5C-25BC-46EE-B8D9-3530184ADCD6)


To build in windows:

Assuming that the Intel OneAPI setvars.bat script is in C:\Program Files (x86)\Intel\oneAPI\setvars.bat.

```powershell
cmd.exe "/K" '"C:\Program Files (x86)\Intel\oneAPI\setvars.bat" && pwsh.exe'

```
You can easily create a shortcut or a script to open a powershell terminal with the proper environment.

After that, navigate to the src folder and run the following to install python deps and build the extension module with python 3.11 in windows:

```Powershell
nmake -f Makefile_win setup
nmake -f Makefile_win
```
--- 

## Alternative: Using gfortran in windows

  - The recommended option is the Intel fortran compiler (ifx.exe) included in the Intel OneAPI HPC toolkit.
  - If you want to use gfortran, you can download a standalone version from [WinLibs](https://winlibs.com/#download-release).
  - Tested with: GCC 14.2.0 (with MCF threads) + MinGW-w64 12.0.0 (UCRT) - release 1
  - Make sure that gfortran.exe is in your PATH environment variable.
  - In this case gfortran is used in conjunction with the MS Visual Compiler (cl.exe). Make sure that both compilers are in your PATH environment variable, for example, by running from the Visual Studio Developer Command Prompt. 
  - Use the script build_caete.bat to build the model with gfortran in windows. This script just applies the numpy.f2py script to build the fortran/python extension module searching for the gfortran and c compilers in the PATH. 


## Linux/MacOS setup

- gnu-make

- gcc

- gfortran

- python >= 3.11 + pip

In linux it is possible to run the model in python 3.11, 3.12 and 3.13. However, the building system used to compile the fortran/python extension module differs between python versions. In python 3.12 the numpy distutils was removed from numpy. See: [Numpy distutils status](https://numpy.org/doc/stable/reference/distutils_status_migration.html#distutils-status-migration). The new (candidate) build method is based on meson. So, if you are using python >=3.12 you will need also:

- meson
- ninja

Note: At the current time, the new building (meson) system was only working on linux. If you are using windows, you will need to use python 3.11.

Python Dependencies: see the [requirements](./src/requirements_3xx_last.txt).

Edit the PYEXEC variable in the [linux Makefile](./src/Makefile) to match the python that you will use to run the model.

Use the make target setup to install python libraries.

To build the extension module in linux, navigate to the src folder and run:

```bash
make setup
make
```
[⇦ Back](./README.md)