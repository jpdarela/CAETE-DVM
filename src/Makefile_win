# ! Copyright 2017- LabTerra

# !     This program is free software: you can redistribute it and/or modify
# !     it under the terms of the GNU General Public License as published by
# !     the Free Software Foundation, either version 3 of the License, or
# !     (at your option) any later version.)

# !     This program is distributed in the hope that it will be useful,
# !     but WITHOUT ANY WARRANTY; without even the implied warranty of
# !     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# !     GNU General Public License for more details.

# !     You should have received a copy of the GNU General Public License
# !     along with this program.  If not, see <http://www.gnu.org/licenses/>.

# ! AUTHOR: JP Darela

# Makefile for Windows to be used with nmake + MSVC + ifx (Intel Fortran Compiler) + f2py

# Variables
# Python executable, package manager and f2py
PYEXEC = py -3.11
PIP = $(PYEXEC) -m pip
F2PY = $(PYEXEC) -m numpy.f2py
CYTHON = $(PYEXEC) -m cython

# Python extension module name. This is the name of the module that will be created by f2py
MODNAME = caete_module

# Fortran interfaces automatically generated by f2py
INTERFACES = $(MODNAME).pyf

# Directory where the Fortran modules are located, in general this is needed only by the editor (linting, etc. by fortls)
MOD_DIR = ./

# Compiler
# Compiler to be used by f2py, in this case ifx (Intel Fortran Compiler) from the intel_oneapi package
# To use gnu-gfortran (in Linux and macOS), use the Makefile provided in the src folder.
FC = ifx

# Flags
# f2py flags
MFLAG = -m
HFLAG = -h
CFLAG = -c
OVRTFLAG = --overwrite-signature


# ifx flags
IFX_FLAGS = -fpp -QxHost -I$(MOD_DIR) -DPREPEND_FORTRAN -DNO_APPEND_FORTRAN -DUPPERCASE_FORTRAN -DUNDERSCORE_G77

# Sources
src_lib = global.f90 funcs.f90 evap.f90 soil_dec.f90 cc.f90 allocation.f90 productivity.f90
sources = $(src_lib) budget.F90

# Targets
.PHONY: setup interface so so_parallel clean_py clean clean_so modules

setup:
	@echo "Installing dependencies..."
	$(PIP) install -r requirements.txt

interface: $(sources)
	echo "Creating Fortran interfaces for the caete_module using f2py..."
	@$(PYEXEC) set_npls.py
	@$(F2PY) $(HFLAG) $(INTERFACES) $(sources) $(MFLAG) $(MODNAME) $(OVRTFLAG) --quiet

so: $(sources) interface
	@$(F2PY) $(INTERFACES) -c $(sources) --f90exec="$(FC)" --f90flags="$(IFX_FLAGS)" --quiet
	@echo "Serial version of caete_module created using $(FC)"
#	$(CYTHON) -a community.py
#	$(CYTHON) -a metacommunity.py
#	$(CYTHON) -a hydro_caete.py
#	$(CYTHON) -a output.py
#	$(PYEXEC) setup.py build_ext --inplace --verbose


so_parallel: $(sources) interface
	$(F2PY) $(INTERFACES) -c $(sources) --f90exec="$(FC)" --f90flags="$(IFX_FLAGS) -qopenmp"
	@echo "Parallel version of caete_module created using $(FC)"
#	$(CYTHON) -a community.py
#	$(CYTHON) -a metacommunity.py
#	$(CYTHON) -a hydro_caete.py
#	$(CYTHON) -a output.py
#	$(PYEXEC) setup.py build_ext --inplace --verbose


modules: $(sources)
	$(FC) -fpp -c $(sources)

clean_py:
	del /s /q __pycache__
	del /s /q build

clean: clean_py
	del /s *.mod
	del /s *.o
	del /s *.s
	del pls_ex.txt
	del run_debug
	del logfile.log
	del /s *.obj

clean_so: clean
	del /s *.pyd
	del /s *.pyf
	del /s *.c
	del /s *.log
	del /s *.psz
	cls

reinstall: clean_so so modules